---
- name: Setup kubeconfig
  ansible.builtin.set_fact:
    kubeconfig: "/root/.kube/config"

- name: Vérification kubeconfig
  ansible.builtin.file:
    path: "/root/.kube"
    state: directory
    mode: '0700'
  when: kubeconfig is defined

- name: Création namespace
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ app_name }}"

- name: Création volume
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    src: "{{ playbook_dir }}/../kubernetes/persistent-volume.yml"
    namespace: "{{ app_name }}"

- name: Déploiement API
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    src: "{{ playbook_dir }}/../kubernetes/api-deployment.yml"
    namespace: "{{ app_name }}"

- name: Déploiement Frontend
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    src: "{{ playbook_dir }}/../kubernetes/frontend-deployment.yml"
    namespace: "{{ app_name }}"

- name: Attente du déploiement de tous les services
  kubernetes.core.k8s_info:
    kind: Deployment
    name: "{{ item }}"
    namespace: "{{ app_name }}"
    wait: yes
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300
  loop:
    - api-deployment
    - frontend-deployment

- name: Vérification status PVC
  kubernetes.core.k8s_info:
    kind: PersistentVolumeClaim
    name: app-data-pvc
    namespace: "{{ app_name }}"
  register: pvc_status
- debug:
    var: pvc_status.resources[0].status.phase